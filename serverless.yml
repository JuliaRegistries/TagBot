service: TagBot
plugins:
  - serverless-python-requirements
custom:
  git: arn:aws:lambda:us-east-1:553035198032:layer:git:5
provider:
  name: aws
  runtime: python3.7
  iamRoleStatements:
    - Effect: Allow
      Action:
        - DynamoDB:GetItem
        - DynamoDB:PutItem
      Resource: !GetAtt table.Arn
    - Effect: Allow
      Action: lambda:InvokeFunction
      Resource: !Join [':', ['arn', 'aws', 'lambda', '${self:provider.region}', !Ref 'AWS::AccountId', 'function', '${self:service}-${self:provider.stage}-*']]
    - Effect: Allow
      Action: sns:Publish
      Resource: !Ref dead
  environment:
    DYNAMODB_TABLE_NAME: !Ref table
    GITHUB_APP_ID: ${env:GITHUB_APP_ID}
    GITHUB_CONTACT_USER: ${env:GITHUB_CONTACT_USER}
    GITHUB_WEBHOOK_SECRET: ${env:GITHUB_WEBHOOK_SECRET}
    GIT_TAGGER_EMAIL: ${env:GIT_TAGGER_EMAIL}
    GIT_TAGGER_NAME: ${env:GIT_TAGGER_NAME}
    LAMBDA_FUNCTION_PREFIX: ${self:service}-${self:provider.stage}-
    REGISTRATOR_USERNAME: ${env:REGISTRATOR_USERNAME}
package:
  exclude:
    - ./**
  include:
    - ./changelog/changelog.rb
    - ./resources.tar
    - ./tagbot/**
    - ./vendor/**
functions:
  webhook:
    description: Validates and forwards a webhook payload from GitHub
    handler: tagbot.handlers.webhook.handler
    events:
      - http:
          path: /github
          method: post
  prepare:
    description: Prepares a context from a GitHub event
    handler: tagbot.handlers.prepare.handler
    onError: !Ref dead
  tag:
    description: Creates a Git tag
    handler: tagbot.handlers.tag.handler
    onError: !Ref dead
    timeout: 900
    memorySize: 3008
    layers:
      - ${self:custom.git}
  changelog:
    description: Creates a release changelog
    runtime: ruby2.5
    handler: changelog/changelog.main
    onError: !Ref dead
    timeout: 900
    memorySize: 3008
    layers:
      - ${self:custom.git}
  release:
    description: Creates a GitHub release
    handler: tagbot.handlers.release.handler
    onError: !Ref dead
  notify:
    description: Comments on a GitHub issue
    handler: tagbot.handlers.notify.handler
    onError: !Ref dead
  failure:
    description: Handles failure
    handler: tagbot.handlers.failure.handler
    events:
      - sns:
          arn: !Ref dead
          topicName: dead
resources:
  Resources:
    dead:
      Type: AWS::SNS::Topic
    table:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
