service: TagBot
plugins:
  - serverless-python-requirements
custom:
  cli: &cli
    timeout: 900
    memorySize: 3008
    layers:
      - arn:aws:lambda:us-east-1:553035198032:layer:git:5
provider:
  name: aws
  runtime: python3.7
  iamRoleStatements:
    - Effect: Allow
      Action:
        - DynamoDB:GetItem
        - DynamoDB:PutItem
      Resource: !GetAtt changelogs.Arn
    - Effect: Allow
      Action: lambda:InvokeFunction
      Resource: !Join [':', ['arn', 'aws', 'lambda', '${self:provider.region}', !Ref 'AWS::AccountId', 'function', '${self:service}-${self:provider.stage}-*']]
    - Effect: Allow
      Action: sns:Publish
      Resource: !Join [':', ['arn', 'aws', 'sns', '${self:provider.region}', !Ref 'AWS::AccountId', '${self:service}-${self:provider.stage}-*']]
  environment:
    GITHUB_APP_ID: ${env:GITHUB_APP_ID}
    LAMBDA_FUNCTION_PREFIX: ${self:service}-${self:provider.stage}-
package:
  exclude:
    - ./**
  include:
    - ./changelog/changelog.rb
    - ./resources.tar
    - ./tagbot/**
    - ./vendor/**
functions:
  webhook:
    description: Validates and forwards a webhook payload from GitHub
    handler: tagbot.handlers.webhook.handler
    environment:
      GITHUB_WEBHOOK_SECRET: ${env:GITHUB_WEBHOOK_SECRET}
    events:
      - http:
          path: /github
          method: post
  prepare:
    description: Prepares a context from a GitHub event
    handler: tagbot.handlers.prepare.handler
    onError: !Ref prepare
    environment:
      GITHUB_APP_NAME: ${env:GITHUB_APP_NAME}
      REGISTRATOR_USERNAME: ${env:REGISTRATOR_USERNAME}
  tag:
    description: Creates a Git tag
    handler: tagbot.handlers.tag.handler
    onError: !Ref tag
    environment:
      GIT_TAGGER_EMAIL: ${env:GIT_TAGGER_EMAIL}
      GIT_TAGGER_NAME: ${env:GIT_TAGGER_NAME}
    <<: *cli
  changelog:
    description: Creates a release changelog
    runtime: ruby2.5
    handler: changelog/changelog.main
    onError: !Ref changelog
    environment:
      DYNAMODB_TABLE_NAME: !Ref changelogs
    <<: *cli
  release:
    description: Creates a GitHub release
    handler: tagbot.handlers.release.handler
    onError: !Ref release
  notify:
    description: Comments on a GitHub issue
    handler: tagbot.handlers.notify.handler
    onError: !Ref notify
  failure:
    description: Handles failure
    handler: tagbot.handlers.failure.handler
    events:
      - sns:
          arn: !Ref prepare
          topicName: prepare
      - sns:
          arn: !Ref tag
          topicName: tag
      - sns:
          arn: !Ref changelog
          topicName: changelog
      - sns:
          arn: !Ref release
          topicName: release
      - sns:
          arn: !Ref notify
          topicName: notify
resources:
  Resources:
    prepare:
      Type: AWS::SNS::Topic
    tag:
      Type: AWS::SNS::Topic
    changelog:
      Type: AWS::SNS::Topic
    release:
      Type: AWS::SNS::Topic
    notify:
      Type: AWS::SNS::Topic
    changelogs:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: N
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
