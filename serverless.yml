service: TagBot
plugins:
  - serverless-python-requirements
custom:
  pythonRequirements:
    layer: true
  cli: &cli
    timeout: 900
    memorySize: 3008
  git: arn:aws:lambda:us-east-1:553035198032:layer:git:5
provider:
  name: aws
  runtime: python3.7
  region: us-east-1
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:PutItem
      Resource: !GetAtt changelogs.Arn
    - Effect: Allow
      Action: lambda:InvokeFunction
      Resource: !Join [':', ['arn', 'aws', 'lambda', '${self:provider.region}', !Ref 'AWS::AccountId', 'function', '${self:service}-${self:provider.stage}-*']]
    - Effect: Allow
      Action: sns:Publish
      Resource: !Join [':', ['arn', 'aws', 'sns', '${self:provider.region}', !Ref 'AWS::AccountId', '${self:service}-${self:provider.stage}-*']]
  environment:
    GITHUB_APP_ID: ${env:GITHUB_APP_ID}
    LAMBDA_FUNCTION_PREFIX: ${self:service}-${self:provider.stage}-
  layers:
    - !Ref PythonRequirementsLambdaLayer
package:
  exclude:
    - ./**
  include:
    - ./resources.tar
    - ./tagbot/**/*.py
layers:
  changelog:
    name: ${self:service}-${self:provider.stage}-changelog
    path: ./layers/changelog
    package:
      exclude:
        - ./**
      include:
        - ./bin/**
        - ./lib/**
functions:
  webhook:
    handler: tagbot.handlers.webhook.handler
    environment:
      GITHUB_WEBHOOK_SECRET: ${env:GITHUB_WEBHOOK_SECRET}
    events:
      - http:
          path: /github
          method: post
  prepare:
    handler: tagbot.handlers.prepare.handler
    onError: !Ref prepare
    environment:
      GITHUB_APP_NAME: ${env:GITHUB_APP_NAME}
      REGISTRATOR_USERNAME: ${env:REGISTRATOR_USERNAME}
  tag:
    handler: tagbot.handlers.tag.handler
    onError: !Ref tag
    environment:
      GIT_TAGGER_EMAIL: ${env:GIT_TAGGER_EMAIL}
      GIT_TAGGER_NAME: ${env:GIT_TAGGER_NAME}
    layers:
      - ${self:custom.git}
      - !Ref PythonRequirementsLambdaLayer
    <<: *cli
  changelog:
    handler: tagbot.handlers.changelog.handler
    onError: !Ref changelog
    environment:
      DYNAMODB_TABLE_NAME: !Ref changelogs
    layers:
      - ${self:custom.git}
      - !Ref ChangelogLambdaLayer
      - !Ref PythonRequirementsLambdaLayer
    <<: *cli
  release:
    handler: tagbot.handlers.release.handler
    onError: !Ref release
  notify:
    handler: tagbot.handlers.notify.handler
    onError: !Ref notify
  failure:
    handler: tagbot.handlers.failure.handler
    events:
      - sns:
          arn: !Ref prepare
          topicName: prepare
      - sns:
          arn: !Ref tag
          topicName: tag
      - sns:
          arn: !Ref changelog
          topicName: changelog
      - sns:
          arn: !Ref release
          topicName: release
      - sns:
          arn: !Ref notify
          topicName: notify
resources:
  Resources:
    prepare:
      Type: AWS::SNS::Topic
    tag:
      Type: AWS::SNS::Topic
    changelog:
      Type: AWS::SNS::Topic
    release:
      Type: AWS::SNS::Topic
    notify:
      Type: AWS::SNS::Topic
    changelogs:
      Type: AWS::DynamoDB::Table
      Properties:
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: N
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
