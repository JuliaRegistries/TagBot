service: TagBot
plugins:
  - serverless-python-requirements
custom:
  lambda-prefix: ${self:service}-${self:provider.stage}-
  git: arn:aws:lambda:us-east-1:553035198032:layer:git:5
provider:
  name: aws
  runtime: python3.7
  iamRoleStatements:
    - Effect: Allow
      Action: lambda:Invoke
      Resource: '*'  # TODO: service-stage-*
  environment:
    GITHUB_APP_ID: ${env:GITHUB_APP_ID}
    GITHUB_CONTACT_USER: ${env:GITHUB_CONTACT_USER}
    GITHUB_WEBHOOK_SECRET: ${env:GITHUB_WEBHOOK_SECRET}
    GIT_TAGGER_EMAIL: ${env:GIT_TAGGER_EMAIL}
    GIT_TAGGER_NAME: ${env:GIT_TAGGER_NAME}
    REGISTRATOR_USERNAME: ${env:REGISTRATOR_USERNAME}
    LAMBDA_FUNCTION_PREFIX: ${self:custom.lambda-prefix}
package:
  exclude:
    - ./**
  include:
    - ./changelog/changelog.rb
    - ./resources.tar
    - ./tagbot/**
    - ./vendor/**
functions:
  webhook:
    description: Validates and forwards a webhook payload from GitHub
    handler: tagbot.webhook.handler
    events:
      - http:
          path: /github
          method: post
  prepare:
    description: Prepares a context from a GitHub event
    handler: tagbot.prepare.handler
    onError: !Ref dead
  tag:
    description: Creates a Git tag
    handler: tagbot.tag.handler
    onError: !Ref dead
    timeout: 900
    memorySize: 3008
    layers:
      - ${self:custom.git}
  changelog:
    description: Creates a release changelog
    runtime: ruby2.5
    handler: changelog/changelog.main
    onError: !Ref dead
    timeout: 900
    memorySize: 3008
    layers:
      - ${self:custom.git}
  release:
    description: Creates a GitHub
    handler: tagbot.release.handler
    onError: !Ref dead
  notify:
    description: Comments on a GitHub issue
    handler: tagbot.notify.handler
    onError: !Ref dead
resources:
  Resources:
    dead:
      Type: AWS::SNS::Topic
