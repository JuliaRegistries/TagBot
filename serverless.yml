service: TagBot
custom:
  sns-prefix: '${self:service}-${self:provider.stage}-'
provider:
  name: aws
  iamRoleStatements:
    - Effect: Allow
      Action: sns:Publish
      Resource: '*'
  environment:
    CHANGELOG_WIP_MESSAGE: A changelog is being generated, please check back in a few minutes.
    GITHUB_APP_ID: ${env:GITHUB_APP_ID}
    GITHUB_CONTACT_USER: ${env:GITHUB_CONTACT_USER}
    GITHUB_WEBHOOK_SECRET: ${env:GITHUB_WEBHOOK_SECRET}
    GIT_TAGGER_EMAIL: ${env:GIT_TAGGER_EMAIL}
    GIT_TAGGER_NAME: ${env:GIT_TAGGER_NAME}
    REGISTRATOR_USERNAME: ${env:REGISTRATOR_USERNAME}
    SNS_PREFIX: !Join [':', ['arn:aws:sns', !Ref 'AWS::Region', !Ref 'AWS::AccountId', '${self:custom.sns-prefix}']]
  layers:
    - arn:aws:lambda:us-east-1:553035198032:layer:git:5
package:
  exclude:
    - ./**
  include:
    - ./changelog/changelog.rb
    - ./github/bin/github
    - ./github/bin/resources.tar
    - ./vendor/**
functions:
  github:
    description: Handles webhook payloads from GitHub and makes GitHub API requests
    runtime: go1.x
    handler: github/bin/github
    events:
      - http:
          path: /github
          method: post
      - sns: ${self:custom.sns-prefix}github
  git:
    description: Uses the Git CLI
    runtime: go1.x
    handler: github/bin/github
    timeout: 900
    memorySize: 3008
    events:
      - sns: ${self:custom.sns-prefix}git
  changelog:
    description: Creates changelogs for releases
    runtime: ruby2.5
    handler: changelog/changelog.main
    timeout: 900
    memorySize: 3008
    events:
      - sns ${self:custom.sns-prefix}changelog
